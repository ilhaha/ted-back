<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="top.continew.admin.training.mapper.CandidateTypeMapper">
    <insert id="insertBatchIgnore">
        INSERT IGNORE INTO ted_candidate_type (candidate_id, type)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.candidateId}, #{item.type})
        </foreach>
    </insert>
    <select id="getWorkerPage" resultType="top.continew.admin.training.model.resp.CandidateTypeDetailResp">
        SELECT tct.id,
               tct.candidate_id,
               tct.is_blacklist,
               tct.blacklist_reason,
               tct.blacklist_duration_type,
               tct.blacklist_time,
               tct.blacklist_end_time,
               su.nickname,
               su.username,
               su.phone,
               su.avatar,
               COUNT(ter.id)                                          AS exam_total_count,
               COUNT(CASE WHEN ter.exam_result_status = 1 THEN 1 END) AS pass_count,

               COUNT(CASE WHEN ter.exam_result_status = 0 THEN 1 END) AS fail_count,

               COUNT(CASE WHEN ter.exam_result_status = 2 THEN 1 END) AS unrecorded_count
        FROM ted_candidate_type tct
                 JOIN sys_user su
                      ON tct.candidate_id = su.id
                 LEFT JOIN ted_exam_records ter
                           ON su.id = ter.candidate_id
                               AND ter.is_deleted = 0
            ${ew.customSqlSegment}
        GROUP BY
            tct.id,
            tct.is_blacklist,
            tct.blacklist_reason,
            tct.blacklist_duration_type,
            tct.blacklist_time,
            tct.blacklist_end_time,
            su.nickname
        ORDER BY id DESC
    </select>

</mapper>