<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="top.continew.admin.exam.mapper.ExamTicketMapper">

    <resultMap id="CandidateTicketResultMap" type="top.continew.admin.exam.model.dto.CandidateTicketDTO">
        <result column="nickname" property="name"/>
        <result column="username" property="idCard"/> <!-- 假设username存储身份证号 -->
        <result column="exam_number" property="ticketId"/>
        <result column="classroom_id" property="classCode"/> <!-- 考场ID作为班级代码 -->
        <result column="classroom_name" property="className"/> <!-- 考场名称作为班级名称 -->
        <result column="category_name" property="examType"/> <!-- 考核种类 -->
        <result column="project_name" property="examItem"/> <!-- 考核项目 -->
        <result column="classroom_name" property="examRoom"/> <!-- 考场名 -->
        <result column="exam_time" property="examTime"/> <!-- 考试时间段 -->
    </resultMap>

    <!-- 根据 userId + examNumber 查询 -->
    <select id="findTicketByUserAndExamNumber" resultMap="CandidateTicketResultMap">
        SELECT
            u.nickname,
            u.username,
            e.exam_number,
            tc.id AS classroom_id,
            tc.classroom_name,
            c.name AS category_name,
            p.project_name,
            CONCAT(
                    DATE_FORMAT(ep.start_time, '%Y-%m-%d %H:%i'),
                    ' - ',
                    DATE_FORMAT(ep.end_time, '%H:%i')
            ) AS exam_time
        FROM ted_enroll e
                 INNER JOIN sys_user u ON e.user_id = u.id
            AND u.id = #{userId}
                 INNER JOIN ted_exam_plan ep ON e.exam_plan_id = ep.id
            AND ep.is_deleted = 0
                 INNER JOIN ted_project p ON ep.exam_project_id = p.id
            AND p.is_deleted = 0
                 INNER JOIN ted_category c ON p.category_id = c.id
            AND c.is_deleted = 0
                 LEFT JOIN ted_classroom tc ON e.classroom_id = tc.id
            AND tc.is_deleted = 0
        WHERE e.exam_number = #{examNumber}
          AND e.is_deleted = 0
            LIMIT 1
    </select>

</mapper>