<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="top.continew.admin.invigilate.mapper.PlanInvigilateMapper">

    <!--
    batchInsertOrUpdateGrades: 批量插入或更新成绩记录
    - 当主键冲突时（记录已存在），仅当review_status != 1时更新字段
    -->
    <insert id="batchInsertOrUpdateGrades" parameterType="java.util.List">
        INSERT INTO ted_exam_records
        (plan_id, candidate_id, exam_scores, answer_sheet_url, registration_progress)
        VALUES
        <!-- 遍历List，生成批量插入的VALUES子句 -->
        <foreach collection="list" item="item" separator=",">
            (
            #{item.planId},
            #{item.candidateId},
            #{item.examScores},
            #{item.answerSheetUrl},
            2 <!-- registration_progress固定为3 -->
            )
        </foreach>
        <!-- 主键冲突时，执行以下更新逻辑 -->
        ON DUPLICATE KEY UPDATE
        exam_scores = IF(review_status != 1, VALUES(exam_scores), exam_scores),
        answer_sheet_url = IF(review_status != 1, VALUES(answer_sheet_url), answer_sheet_url),
        registration_progress = IF(review_status != 1, VALUES(registration_progress), registration_progress);
    </insert>
    <select id="getListByPlanId" resultType="top.continew.admin.invigilate.model.resp.InvigilatorAssignResp">
        SELECT su.nickname, tpi.invigilator_id, tc.id AS classroom_id, tc.classroom_name, tpi.invigilate_status,tpi.id,tpi.exam_password,tc.exam_type
        from ted_plan_invigilate tpi
                 LEFT JOIN ted_classroom tc
                           ON tpi.classroom_id = tc.id AND tc.is_deleted = 0
                 LEFT JOIN sys_user su
                           ON tpi.invigilator_id = su.id
        where tpi.exam_plan_id = #{planId}
    </select>
    <select id="selectAvailableInvigilators"
            resultType="top.continew.admin.invigilate.model.resp.AvailableInvigilatorResp">
        SELECT su.id, su.nickname
        FROM sys_user su
        JOIN sys_user_role sur
        ON su.id = sur.user_id
        AND sur.role_id = #{invigilatorRole}
        WHERE NOT EXISTS (
        SELECT 1
        FROM ted_plan_invigilate tpi
        JOIN ted_exam_plan tep
        ON tpi.exam_plan_id = tep.id
        AND tep.id != #{planId}
        AND tep.is_final_confirmed IN (1, 2)
        AND tep.start_time &lt; DATE_ADD(#{endTime}, INTERVAL 30 MINUTE)
        AND tep.end_time &gt; DATE_SUB(#{startTime}, INTERVAL 30 MINUTE)
        WHERE tpi.invigilator_id = su.id
        AND tpi.invigilate_status != 5
        )
        <if test="rejectedInvigilatorId != null">
            AND su.id != #{rejectedInvigilatorId}
        </if>
    </select>


</mapper>